<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NEXCARD • Acceso</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#f7fbff; --bg1:#eef4ff;
      --card:rgba(255,255,255,.72);
      --border:rgba(6,26,45,.12);
      --text:#0b1b2a; --muted:#5b6672;
      --navy:#061A2D; --navy2:#0A2A4A; --navy3:#0F3B6A;
      --shadow:0 24px 70px rgba(0,0,0,.16);
      --shadow-soft:0 12px 28px rgba(6,26,45,.12);
      --ease:cubic-bezier(.22,1,.36,1);
    }
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:'Open Sans',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 10% 10%, rgba(33,161,255,.18), transparent 55%),
        radial-gradient(900px 700px at 90% 30%, rgba(99,211,255,.14), transparent 55%),
        linear-gradient(135deg,var(--bg0) 0%, var(--bg1) 100%);
      overflow:hidden;
      display:flex; align-items:center; justify-content:center;
      padding:22px;
    }
    .bg-accent{position:fixed; inset:-20%; pointer-events:none; filter:blur(42px); z-index:0;}
    .bg-accent::before,.bg-accent::after{
      content:""; position:absolute;
      width:min(520px, 72vw); height:min(520px, 72vw);
      border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(33,161,255,.52), rgba(33,161,255,.05) 70%, transparent 72%);
      animation: floatBlob 10s var(--ease) infinite;
    }
    .bg-accent::before{top:1%; left:6%}
    .bg-accent::after{
      bottom:-2%; right:2%;
      background: radial-gradient(circle at 30% 30%, rgba(15,59,106,.58), rgba(15,59,106,.08) 70%, transparent 72%);
      animation-duration:12s; animation-direction:reverse;
    }
    @keyframes floatBlob{
      0%{transform:translate3d(0,0,0) scale(1)}
      40%{transform:translate3d(30px,-25px,0) scale(1.05)}
      70%{transform:translate3d(-18px,18px,0) scale(.98)}
      100%{transform:translate3d(0,0,0) scale(1)}
    }

    .panel{
      width:min(520px, 92vw);
      background: rgba(255,255,255,.44);
      border:1px solid rgba(255,255,255,.35);
      border-radius:28px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
      transform: translateY(10px);
      opacity:0;
      animation: in .7s var(--ease) forwards;
      z-index:2;
    }
    @keyframes in { to{ transform: translateY(0); opacity:1; } }

    .brand{
      display:flex; align-items:center; gap:12px;
      padding:18px;
      background:
        radial-gradient(900px 320px at 15% 0%, rgba(33,161,255,.22), transparent 55%),
        linear-gradient(135deg, var(--navy) 0%, var(--navy2) 55%, var(--navy3) 100%);
      color:white;
      border-bottom:1px solid rgba(255,255,255,.12);
    }
    .mark{
      width:44px;height:44px;border-radius:16px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.22);
      box-shadow:0 14px 40px rgba(0,0,0,.22);
      position:relative; overflow:hidden;
    }
    .mark::after{
      content:""; position:absolute; inset:-40%;
      background: conic-gradient(from 180deg, rgba(33,161,255,0), rgba(33,161,255,.35), rgba(255,255,255,0));
      animation: spin 5s linear infinite;
      opacity:.8;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    .brand h1{font-family:'Montserrat',system-ui,sans-serif;font-size:20px;letter-spacing:-.02em;margin:0}
    .brand p{margin-top:4px;color:rgba(255,255,255,.85);font-weight:800;font-size:12px;letter-spacing:.08em;text-transform:uppercase}

    .card{
      margin:18px;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:22px;
      box-shadow:var(--shadow-soft);
      padding:18px;
    }

    h2{
      font-family:'Montserrat',system-ui,sans-serif;
      font-size:22px;
      letter-spacing:-.02em;
      margin-bottom:10px;
    }

    label{
      display:block;
      font-size:12px;
      font-weight:950;
      letter-spacing:.06em;
      text-transform:uppercase;
      color:rgba(11,27,42,.82);
      margin:10px 0 6px;
    }
    .in{
      width:100%;
      height:48px;
      padding:0 14px;
      border:1px solid rgba(6,26,45,.12);
      border-radius:14px;
      font-size:15px;
      font-weight:650;
      background:rgba(255,255,255,.88);
      transition: transform .18s var(--ease), border-color .18s var(--ease), box-shadow .18s var(--ease);
    }
    .in:focus{
      outline:none;
      border-color: rgba(33,161,255,.85);
      box-shadow: 0 0 0 4px rgba(33,161,255,.18), 0 14px 40px rgba(6,26,45,.12);
      transform: translateY(-1px);
      background:#fff;
    }

    .row{display:flex; gap:10px; margin-top:14px}
    .btn{
      height:50px;
      border:none;
      border-radius:16px;
      font-weight:950;
      letter-spacing:.06em;
      text-transform:uppercase;
      cursor:pointer;
      padding:0 14px;
      display:flex; align-items:center; justify-content:center; gap:10px;
      transition: transform .18s var(--ease), box-shadow .18s var(--ease), filter .18s var(--ease);
      user-select:none;
      white-space:nowrap;
    }
    .btn-primary{
      flex:1;
      color:white;
      background:
        radial-gradient(160px 120px at 20% 10%, rgba(99,211,255,.55), transparent 55%),
        linear-gradient(135deg, var(--navy) 0%, var(--navy2) 55%, var(--navy3) 100%);
      box-shadow: 0 18px 40px rgba(6,26,45,.26);
    }
    .btn-primary:hover{transform: translateY(-1px); box-shadow:0 24px 60px rgba(6,26,45,.34); filter:saturate(1.05)}
    .btn-ghost{
      width:120px;
      background:rgba(255,255,255,.65);
      border:1px solid rgba(6,26,45,.12);
      color:var(--navy2);
      box-shadow:var(--shadow-soft);
    }
    .btn:disabled{ opacity:.65; cursor:not-allowed; transform:none; }

    .spinner{
      width:16px;height:16px;
      border:2px solid rgba(255,255,255,.9);
      border-top-color:transparent;
      border-radius:999px;
      animation: spin2 .7s linear infinite;
    }
    @keyframes spin2{ to{ transform: rotate(360deg); } }

    .err{
      display:none;
      background: rgba(255, 59, 59, 0.08);
      border: 1px solid rgba(255, 59, 59, 0.18);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 14px;
      color: #b42318;
      font-weight: 800;
      margin-top: 12px;
    }

    .note{
      margin-top:10px;
      font-size:12px;
      color:rgba(91,102,114,.95);
      font-weight:800;
      line-height:1.45;
    }
  </style>
</head>

<body>
  <div class="bg-accent"></div>

  <div class="panel" role="dialog" aria-label="Acceso al panel NEXCARD">
    <div class="brand">
      <div class="mark" aria-hidden="true"></div>
      <div>
        <h1>NEXCARD</h1>
        <p>Acceso al panel</p>
      </div>
    </div>

    <div class="card">
      <h2>Iniciar sesión</h2>

      <form id="loginForm" autocomplete="on">
        <label for="email">Email</label>
        <input class="in" id="email" type="email" autocomplete="username" required>

        <label for="password">Contraseña</label>
        <input class="in" id="password" type="password" autocomplete="current-password" required>

        <div class="row">
          <button class="btn btn-primary" id="btnLogin" type="submit">Entrar</button>
          <button class="btn btn-ghost" id="btnClear" type="button">Limpiar</button>
        </div>

        <div class="err" id="errBox"></div>
        <div class="note">
          Si es tu primera vez en este navegador, el dashboard te pedirá el <b>empresa_id</b> una sola vez.
        </div>
      </form>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const API_BASE = "https://script.google.com/macros/s/AKfycbx7ghGSC47jyKY5ArI2s1JpO3UILEHVzmfaHxYxG3sLYfN3QDyFYWnXFStRLHvdJGtXRQ/exec";
    const TOKEN_KEY = "nexcard_token";
    const EMPRESA_KEY = "nexcard_empresa_id";

    // ====== JSONP ======
    function jsonp(url){
      return new Promise((resolve, reject)=>{
        const cb = "cb_" + Math.random().toString(36).slice(2);
        const s = document.createElement("script");
        window[cb] = (data)=>{ try{delete window[cb]}catch(_){} s.remove(); resolve(data); };
        s.onerror = ()=>{ try{delete window[cb]}catch(_){} s.remove(); reject(new Error("No se pudo conectar")); };
        s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
        document.body.appendChild(s);
      });
    }

    function showErr(msg){
      const box = document.getElementById("errBox");
      box.textContent = msg;
      box.style.display = "block";
    }
    function clearErr(){
      const box = document.getElementById("errBox");
      box.textContent = "";
      box.style.display = "none";
    }

    document.getElementById("btnClear").addEventListener("click", ()=>{
      document.getElementById("email").value = "";
      document.getElementById("password").value = "";
      clearErr();
    });

    // Si ya hay token, mandamos al dashboard
    (function autoRedirectIfToken(){
      const t = localStorage.getItem(TOKEN_KEY);
      if(t && t.trim()){
        location.href = "dashboard.html";
      }
    })();

    document.getElementById("loginForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      clearErr();

      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;

      const btn = document.getElementById("btnLogin");
      const old = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner"></div> Entrando…';

      try{
        const qs = new URLSearchParams({ action:"login", email, password });
        const data = await jsonp(`${API_BASE}?${qs.toString()}`);

        if(!data || data.ok !== true){
          throw new Error((data && data.message) ? data.message : "Login falló");
        }

        // Guardar token
        localStorage.setItem(TOKEN_KEY, data.token);

        // NO tocamos empresa_id aquí porque el backend no lo devuelve.
        // Si ya existe guardado de antes, se conserva.
        const existingEmp = (localStorage.getItem(EMPRESA_KEY) || "").trim();
        if(!existingEmp){
          // lo dejamos vacío para que el dashboard lo pida una sola vez
          localStorage.removeItem(EMPRESA_KEY);
        }

        location.href = "dashboard.html";

      }catch(err){
        showErr(String(err && err.message ? err.message : err));
        btn.disabled = false;
        btn.innerHTML = old;
      }
    });
  </script>
</body>
</html>
