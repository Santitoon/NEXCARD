<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NEXCARD • Dashboard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#f7fbff;
      --bg1:#eef4ff;
      --card:rgba(255,255,255,.72);
      --card2:rgba(255,255,255,.88);
      --border:rgba(6,26,45,.12);
      --text:#0b1b2a;
      --muted:#5b6672;

      --navy:#061A2D;
      --navy2:#0A2A4A;
      --navy3:#0F3B6A;

      --accent:#21A1FF;
      --accent2:#63D3FF;

      --shadow: 0 24px 70px rgba(0,0,0,.16);
      --shadow-soft: 0 12px 30px rgba(6,26,45,.12);

      --r-xl: 28px;
      --r-lg: 22px;
      --r-md: 14px;
      --ease: cubic-bezier(.22,1,.36,1);
    }

    *{ margin:0; padding:0; box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      font-family:'Open Sans',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 10% 10%, rgba(33,161,255,.18), transparent 55%),
        radial-gradient(900px 700px at 90% 30%, rgba(99,211,255,.14), transparent 55%),
        linear-gradient(135deg,var(--bg0) 0%, var(--bg1) 100%);
      overflow-x:hidden;
    }

    /* Grid sutil */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background-image:
        linear-gradient(to right, rgba(6,26,45,.05) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(6,26,45,.05) 1px, transparent 1px);
      background-size: 44px 44px;
      mask-image: radial-gradient(circle at 30% 20%, rgba(0,0,0,.85), rgba(0,0,0,.12) 55%, transparent 72%);
      opacity:.35;
      z-index:0;
    }

    .bg-accent{
      position:fixed;
      inset:-20%;
      pointer-events:none;
      z-index:0;
      filter: blur(42px);
    }
    .bg-accent::before,
    .bg-accent::after{
      content:"";
      position:absolute;
      width:min(540px, 70vw);
      height:min(540px, 70vw);
      border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(33,161,255,.52), rgba(33,161,255,.05) 70%, transparent 72%);
      transform: translate3d(0,0,0);
      animation: floatBlob 10s var(--ease) infinite;
      will-change: transform;
    }
    .bg-accent::before{ top: 2%; left: 6%; }
    .bg-accent::after{
      bottom: 0%;
      right: 2%;
      background: radial-gradient(circle at 30% 30%, rgba(15,59,106,.58), rgba(15,59,106,.08) 70%, transparent 72%);
      animation-duration: 12s;
      animation-direction: reverse;
    }
    @keyframes floatBlob{
      0%{ transform: translate3d(0,0,0) scale(1); }
      40%{ transform: translate3d(30px, -25px, 0) scale(1.05); }
      70%{ transform: translate3d(-18px, 18px, 0) scale(.98); }
      100%{ transform: translate3d(0,0,0) scale(1); }
    }

    .wrap{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: clamp(16px, 4vw, 28px);
      position:relative;
      z-index:1;
    }

    .panel{
      width:min(1180px, 100%);
      background: rgba(255,255,255,.44);
      border: 1px solid rgba(255,255,255,.35);
      border-radius: var(--r-xl);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
      transform: translateY(10px);
      opacity:0;
      animation: in .7s var(--ease) forwards;
    }
    @keyframes in { to { transform: translateY(0); opacity:1; } }

    .topbar{
      padding: 18px 18px 16px;
      background:
        radial-gradient(900px 320px at 15% 0%, rgba(33,161,255,.22), transparent 55%),
        linear-gradient(135deg, var(--navy) 0%, var(--navy2) 55%, var(--navy3) 100%);
      color:#fff;
      border-bottom: 1px solid rgba(255,255,255,.12);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }

    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .mark{
      width:44px;height:44px;border-radius:16px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.22);
      box-shadow:0 14px 40px rgba(0,0,0,.22);
      position:relative;
      overflow:hidden;
    }
    .mark::after{
      content:"";
      position:absolute;
      inset:-40%;
      background: conic-gradient(from 180deg, rgba(33,161,255,0), rgba(33,161,255,.35), rgba(255,255,255,0));
      animation: spinGlow 5s linear infinite;
      opacity:.8;
    }
    @keyframes spinGlow{ to{ transform: rotate(360deg); } }

    .brand h1{
      font-family:'Montserrat',system-ui,sans-serif;
      font-size: 18px;
      letter-spacing:-.01em;
      margin:0;
    }
    .brand p{
      margin-top:4px;
      font-weight:800;
      color: rgba(255,255,255,.85);
      font-size: 12px;
      letter-spacing:.08em;
      text-transform:uppercase;
    }

    .top-right{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.10);
      font-weight:900;
      letter-spacing:.02em;
      color:#fff;
      user-select:none;
    }
    .chip small{ opacity:.88; font-weight:800; }

    .btn{
      border:none;
      cursor:pointer;
      border-radius: 16px;
      height:44px;
      padding:0 14px;
      font-weight:950;
      letter-spacing:.06em;
      text-transform:uppercase;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition: transform .18s var(--ease), box-shadow .18s var(--ease), filter .18s var(--ease);
      user-select:none;
      white-space:nowrap;
    }
    .btn:active{ transform: scale(.98); }
    .btn-light{
      background: rgba(255,255,255,.92);
      color: var(--navy2);
      border:1px solid rgba(255,255,255,.25);
      box-shadow: var(--shadow-soft);
    }
    .btn-primary{
      color:#fff;
      background:
        radial-gradient(160px 120px at 20% 10%, rgba(99,211,255,.55), transparent 55%),
        linear-gradient(135deg, var(--navy) 0%, var(--navy2) 55%, var(--navy3) 100%);
      box-shadow: 0 18px 40px rgba(6,26,45,.26);
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; transform:none; }

    .content{
      padding: 18px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }
    @media(min-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--r-lg);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      overflow:hidden;
    }

    .section{
      padding: 16px;
      border-bottom: 1px solid rgba(6,26,45,.08);
    }
    .section:last-child{ border-bottom:none; }

    .h{
      font-family:'Montserrat',system-ui,sans-serif;
      font-weight: 800;
      font-size: 18px;
      letter-spacing:-.01em;
      margin:0;
    }
    .sub{
      margin-top:6px;
      color: rgba(255,255,255,.86);
      font-weight: 800;
      font-size: 12px;
      letter-spacing:.06em;
      text-transform:uppercase;
    }
    .muted{ color: var(--muted); font-weight:700; }

    /* KPIs */
    .kpis{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    @media(min-width: 980px){
      .kpis{ grid-template-columns: repeat(4, 1fr); }
    }
    .kpi{
      background: rgba(255,255,255,.86);
      border: 1px solid rgba(6,26,45,.10);
      border-radius: 18px;
      padding: 12px 12px;
    }
    .kpi .n{
      font-family:'Montserrat',system-ui,sans-serif;
      font-size: 22px;
      font-weight: 900;
      letter-spacing:-.01em;
    }
    .kpi .l{
      margin-top:4px;
      color: rgba(91,102,114,.95);
      font-weight: 800;
      font-size: 12px;
      letter-spacing:.04em;
      text-transform:uppercase;
    }

    /* Controls */
    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .controls-left{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      flex:1;
      min-width: 280px;
    }
    .in, .sel{
      height:44px;
      padding:0 12px;
      border-radius: 14px;
      border:1px solid rgba(6,26,45,.12);
      background: rgba(255,255,255,.86);
      font-weight: 800;
      color: var(--text);
      outline:none;
      transition: box-shadow .18s var(--ease), border-color .18s var(--ease), transform .18s var(--ease);
    }
    .in{ width: min(420px, 100%); }
    .sel{ width: 190px; }
    .in:focus, .sel:focus{
      border-color: rgba(33,161,255,.85);
      box-shadow: 0 0 0 4px rgba(33,161,255,.18), 0 14px 40px rgba(6,26,45,.12);
      transform: translateY(-1px);
      background:#fff;
    }

    /* Table */
    .table-wrap{
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(6,26,45,.10);
      border-radius: 18px;
      overflow:auto;
    }
    table{
      width:100%;
      border-collapse: collapse;
      min-width: 860px;
    }
    th, td{
      padding: 12px 12px;
      border-bottom: 1px solid rgba(6,26,45,.08);
      text-align:left;
      font-weight: 800;
      font-size: 13px;
    }
    th{
      position: sticky;
      top:0;
      background: #f3f8ff;
      z-index: 1;
      font-weight: 950;
    }
    tr:hover td{ background: rgba(33,161,255,.05); }
    td.actions{ white-space:nowrap; }

    .mini-btn{
      height:34px;
      padding:0 12px;
      border-radius: 12px;
      border:1px solid rgba(6,26,45,.12);
      background:#fff;
      font-weight: 950;
      cursor:pointer;
      transition: transform .15s var(--ease);
    }
    .mini-btn:hover{ transform: translateY(-1px); }

    /* Empty */
    .empty{
      background: rgba(6,26,45,.04);
      border: 1px solid rgba(6,26,45,.10);
      border-radius: 18px;
      padding: 14px;
      font-weight: 800;
      color: rgba(91,102,114,.95);
    }

    /* Pagination */
    .pager{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .pager .info{ font-weight:800; color: rgba(91,102,114,.95); }

    /* Modal */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background: rgba(11,27,42,.38);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index:50;
    }
    .modal.show{ display:flex; }
    .modal-card{
      width: min(920px, 100%);
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(255,255,255,.35);
      border-radius: 22px;
      box-shadow: 0 30px 90px rgba(15,23,42,.28);
      overflow:hidden;
    }
    .modal-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 14px 14px;
      border-bottom: 1px solid rgba(6,26,45,.10);
    }
    .modal-head h3{
      margin:0;
      font-family:'Montserrat',system-ui,sans-serif;
      font-weight: 900;
      letter-spacing:-.01em;
      font-size: 16px;
    }
    .modal-body{
      padding: 14px;
      max-height: 70vh;
      overflow:auto;
    }
    .form-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media(min-width: 860px){
      .form-grid{ grid-template-columns: 1fr 1fr; }
    }
    .fg{
      background: rgba(6,26,45,.04);
      border: 1px solid rgba(6,26,45,.10);
      border-radius: 16px;
      padding: 10px;
    }
    .fg label{
      display:block;
      font-size: 11px;
      font-weight: 950;
      letter-spacing:.06em;
      text-transform:uppercase;
      color: rgba(11,27,42,.78);
      margin-bottom: 6px;
    }
    .fg .v{
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(6,26,45,.10);
      border-radius: 12px;
      padding: 10px 10px;
      font-weight: 850;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform: translateX(-50%);
      background: rgba(255,255,255,.94);
      border: 1px solid rgba(6,26,45,.12);
      border-radius: 16px;
      padding: 12px 14px;
      box-shadow: 0 14px 40px rgba(15,23,42,.18);
      font-weight: 950;
      display:none;
      z-index:60;
      max-width: min(720px, calc(100% - 24px));
    }

    .hidden{ display:none; }

    @media (prefers-reduced-motion: reduce){
      *{ animation-duration: 0.001ms !important; animation-iteration-count: 1 !important; transition-duration: 0.001ms !important; scroll-behavior: auto !important; }
      .bg-accent{ display:none; }
    }
  </style>
</head>

<body>
  <div class="bg-accent"></div>

  <div class="wrap">
    <div class="panel">
      <div class="topbar">
        <div class="brand">
          <div class="mark" aria-hidden="true"></div>
          <div>
            <h1>NEXCARD</h1>
            <div class="sub">Dashboard</div>
          </div>
        </div>

        <div class="top-right">
          <div class="chip" id="whoChip">Cargando…</div>
          <div class="chip" id="empresaChip">Empresa: <small id="empresaId">—</small></div>
          <button class="btn btn-light" id="refreshBtn" type="button">Actualizar</button>
          <button class="btn btn-primary" id="logoutBtn" type="button">Cerrar sesión</button>
        </div>
      </div>

      <div class="content">
        <div class="grid">

          <div class="card">
            <div class="section">
              <div class="kpis">
                <div class="kpi"><div class="n" id="kpiTotal">—</div><div class="l">Registros</div></div>
                <div class="kpi"><div class="n" id="kpiHoy">—</div><div class="l">Hoy</div></div>
                <div class="kpi"><div class="n" id="kpiSemana">—</div><div class="l">7 días</div></div>
                <div class="kpi"><div class="n" id="kpiMes">—</div><div class="l">30 días</div></div>
              </div>
            </div>

            <div class="section">
              <div class="controls">
                <div class="controls-left">
                  <input class="in" id="search" type="text" placeholder="Buscar por nombre, email, teléfono, etc.">
                  <select class="sel" id="filterVendedor">
                    <option value="">Vendedor: Todos</option>
                  </select>
                  <select class="sel" id="filterInteres">
                    <option value="">Interés: Todos</option>
                  </select>
                </div>

                <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
                  <button class="btn btn-light" id="clearBtn" type="button">Limpiar</button>
                  <button class="btn btn-light" id="exportBtn" type="button">Exportar CSV</button>
                </div>
              </div>
            </div>

            <div class="section">
              <div class="table-wrap" id="tableWrap">
                <table>
                  <thead>
                    <tr id="theadRow"></tr>
                  </thead>
                  <tbody id="tbody"></tbody>
                </table>
              </div>

              <div class="empty hidden" id="emptyBox">No hay registros.</div>

              <div class="pager">
                <div class="info" id="rowsInfo">—</div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <button class="btn btn-light" id="prevBtn" type="button">Anterior</button>
                  <button class="btn btn-light" id="nextBtn" type="button">Siguiente</button>
                </div>
                <div class="info" id="pageInfo">—</div>
              </div>
            </div>

          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Modal detalle -->
  <div class="modal" id="modal">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="modalTitle">Detalle</h3>
        <button class="btn btn-light" id="modalClose" type="button">Cerrar</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ====== CONFIG ======
    const API_BASE = "https://script.google.com/macros/s/AKfycbx7ghGSC47jyKY5ArI2s1JpO3UILEHVzmfaHxYxG3sLYfN3QDyFYWnXFStRLHvdJGtXRQ/exec";
    const TOKEN_KEY = "nexcard_token";
    const EMPRESA_KEY = "nexcard_empresa_id";
    const PAGE_SIZE = 25;

    // ====== STATE ======
    let token = localStorage.getItem(TOKEN_KEY) || "";
    let empresa_id = (localStorage.getItem(EMPRESA_KEY) || "").trim().toLowerCase();

    let headers = [];
    let rows = [];
    let filtered = [];
    let page = 1;
    let totalPages = 1;

    // Column detection
    let idCol = null;
    let dateCol = null;
    let vendedorCol = null;
    let interesCol = null;

    // ====== DOM ======
    const whoChip = document.getElementById("whoChip");
    const empresaIdEl = document.getElementById("empresaId");

    const refreshBtn = document.getElementById("refreshBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    const searchEl = document.getElementById("search");
    const filterVendedorEl = document.getElementById("filterVendedor");
    const filterInteresEl = document.getElementById("filterInteres");
    const clearBtn = document.getElementById("clearBtn");
    const exportBtn = document.getElementById("exportBtn");

    const theadRow = document.getElementById("theadRow");
    const tbody = document.getElementById("tbody");
    const emptyBox = document.getElementById("emptyBox");

    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const pageInfo = document.getElementById("pageInfo");
    const rowsInfo = document.getElementById("rowsInfo");

    const kpiTotal = document.getElementById("kpiTotal");
    const kpiHoy = document.getElementById("kpiHoy");
    const kpiSemana = document.getElementById("kpiSemana");
    const kpiMes = document.getElementById("kpiMes");

    const modal = document.getElementById("modal");
    const modalTitle = document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");
    const modalClose = document.getElementById("modalClose");

    const toastEl = document.getElementById("toast");

    // ====== HELPERS ======
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> toastEl.style.display="none", 1800);
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function jsonp(url){
      return new Promise((resolve, reject) => {
        const cb = "cb_" + Math.random().toString(36).slice(2);
        const s = document.createElement("script");
        window[cb] = (data) => {
          try { delete window[cb]; } catch(_){}
          s.remove();
          resolve(data);
        };
        s.onerror = () => {
          try { delete window[cb]; } catch(_){}
          s.remove();
          reject(new Error("No se pudo conectar con el servidor."));
        };
        s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
        document.body.appendChild(s);
      });
    }

    function parseDate(v){
      if (v == null) return null;
      if (v instanceof Date && !isNaN(v.getTime())) return v;
      const s = String(v).trim();
      if(!s) return null;
      const d = new Date(s);
      if(!isNaN(d.getTime())) return d;
      return null;
    }

    function findHeader(candidates){
      const low = headers.map(h => String(h||"").trim().toLowerCase());
      for(const c of candidates){
        const idx = low.indexOf(String(c).trim().toLowerCase());
        if(idx >= 0) return headers[idx];
      }
      return null;
    }

    function fillSelect(selectEl, values, placeholder){
      const cur = selectEl.value || "";
      selectEl.innerHTML = "";
      const o0 = document.createElement("option");
      o0.value = "";
      o0.textContent = placeholder;
      selectEl.appendChild(o0);
      values.forEach(v=>{
        const o = document.createElement("option");
        o.value = v;
        o.textContent = v;
        selectEl.appendChild(o);
      });
      if ([...selectEl.options].some(o=>o.value===cur)) selectEl.value = cur;
    }

    function openModal(title, html){
      modalTitle.textContent = title;
      modalBody.innerHTML = html;
      modal.classList.add("show");
    }
    function closeModal(){
      modal.classList.remove("show");
      modalBody.innerHTML = "";
    }

    modalClose.addEventListener("click", closeModal);
    modal.addEventListener("click", (e)=>{ if(e.target === modal) closeModal(); });

    async function apiMe(){
      const qs = new URLSearchParams({ action:"me", token });
      const data = await jsonp(`${API_BASE}?${qs.toString()}`);
      if(!data || data.ok !== true) throw new Error(data?.message || "No se pudo validar sesión.");
      return data;
    }

    async function apiListLeads(){
      const qs = new URLSearchParams({ action:"listLeads", token, empresa_id });
      const data = await jsonp(`${API_BASE}?${qs.toString()}`);
      if(!data || data.ok !== true) throw new Error(data?.message || "No se pudo cargar la base de datos.");
      return data;
    }

    function ensureSessionOrRedirect(){
      if(!token){
        location.href = "login.html";
        return false;
      }
      return true;
    }

    // ====== RENDER ======
    function computeKPIs(){
      const now = new Date();
      const startToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const msDay = 24*60*60*1000;

      let total = rows.length;
      let hoy = 0, semana = 0, mes = 0;

      for(const r of rows){
        const d = dateCol ? parseDate(r[dateCol]) : null;
        if(!d) continue;
        const diff = now.getTime() - d.getTime();
        if(d >= startToday) hoy++;
        if(diff <= 7*msDay) semana++;
        if(diff <= 30*msDay) mes++;
      }

      kpiTotal.textContent = String(total);
      kpiHoy.textContent = String(hoy);
      kpiSemana.textContent = String(semana);
      kpiMes.textContent = String(mes);
    }

    function buildHeader(){
      theadRow.innerHTML = "";
      // mostramos todo excepto ID si existe
      const visible = headers.filter(h => h !== idCol);
      visible.forEach(h=>{
        const th = document.createElement("th");
        th.textContent = h;
        theadRow.appendChild(th);
      });
      const thA = document.createElement("th");
      thA.textContent = "Acciones";
      theadRow.appendChild(thA);
    }

    function buildFilters(){
      const vSet = new Set();
      const iSet = new Set();

      if(vendedorCol){
        rows.forEach(r=>{
          const v = String(r[vendedorCol]||"").trim();
          if(v) vSet.add(v);
        });
      }
      if(interesCol){
        rows.forEach(r=>{
          const v = String(r[interesCol]||"").trim();
          if(v) iSet.add(v);
        });
      }

      fillSelect(filterVendedorEl, [...vSet].sort((a,b)=>a.localeCompare(b)), "Vendedor: Todos");
      fillSelect(filterInteresEl, [...iSet].sort((a,b)=>a.localeCompare(b)), "Interés: Todos");
    }

    function applyFilters(){
      let out = rows.slice();

      // ordenar por fecha desc si existe
      if(dateCol){
        out.sort((a,b)=>{
          const da = parseDate(a[dateCol])?.getTime() || 0;
          const db = parseDate(b[dateCol])?.getTime() || 0;
          return db - da;
        });
      }

      const q = (searchEl.value || "").trim().toLowerCase();
      const fv = (filterVendedorEl.value || "").trim();
      const fi = (filterInteresEl.value || "").trim();

      if(fv && vendedorCol) out = out.filter(r => String(r[vendedorCol]||"").trim() === fv);
      if(fi && interesCol) out = out.filter(r => String(r[interesCol]||"").trim() === fi);

      if(q){
        const visible = headers.filter(h => h !== idCol);
        out = out.filter(r => visible.some(h => String(r[h]||"").toLowerCase().includes(q)));
      }

      filtered = out;
      page = 1;
      renderPage();
    }

    function renderPage(){
      totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
      page = Math.min(Math.max(1, page), totalPages);

      const start = (page - 1) * PAGE_SIZE;
      const pageRows = filtered.slice(start, start + PAGE_SIZE);

      tbody.innerHTML = "";
      emptyBox.classList.toggle("hidden", filtered.length > 0);

      const visible = headers.filter(h => h !== idCol);

      pageRows.forEach(r=>{
        const tr = document.createElement("tr");
        visible.forEach(h=>{
          const td = document.createElement("td");
          td.innerHTML = escapeHtml(r[h]);
          tr.appendChild(td);
        });

        const tdA = document.createElement("td");
        tdA.className = "actions";
        const rid = idCol ? String(r[idCol]||"").trim() : "";
        tdA.innerHTML = `<button class="mini-btn" data-act="view" data-id="${escapeHtml(rid)}">Ver</button>`;
        tr.appendChild(tdA);

        tbody.appendChild(tr);
      });

      prevBtn.disabled = page <= 1;
      nextBtn.disabled = page >= totalPages;

      rowsInfo.textContent = `${filtered.length} resultado(s)`;
      pageInfo.textContent = `Página ${page} / ${totalPages}`;
    }

    function exportCSV(){
      if(!filtered.length){
        toast("No hay datos para exportar.");
        return;
      }
      const visible = headers.filter(h => h !== idCol);
      const esc = (v) => {
        const s = String(v ?? "");
        if (/[,"\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
        return s;
      };

      const lines = [];
      lines.push(visible.map(esc).join(","));
      filtered.forEach(r=>{
        lines.push(visible.map(h => esc(r[h])).join(","));
      });

      const blob = new Blob([lines.join("\n")], { type:"text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `nexcard_${empresa_id || "empresa"}_leads.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("CSV descargado.");
    }

    // ====== EVENTS ======
    refreshBtn.addEventListener("click", async ()=>{
      refreshBtn.disabled = true;
      try{
        await loadAll(true);
      }finally{
        refreshBtn.disabled = false;
      }
    });

    logoutBtn.addEventListener("click", ()=>{
      localStorage.removeItem(TOKEN_KEY);
      localStorage.removeItem(EMPRESA_KEY);
      location.href = "login.html";
    });

    searchEl.addEventListener("input", applyFilters);
    filterVendedorEl.addEventListener("change", applyFilters);
    filterInteresEl.addEventListener("change", applyFilters);

    clearBtn.addEventListener("click", ()=>{
      searchEl.value = "";
      filterVendedorEl.value = "";
      filterInteresEl.value = "";
      applyFilters();
    });

    exportBtn.addEventListener("click", exportCSV);

    prevBtn.addEventListener("click", ()=>{ if(page > 1){ page--; renderPage(); } });
    nextBtn.addEventListener("click", ()=>{ if(page < totalPages){ page++; renderPage(); } });

    document.addEventListener("click", (e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;

      const act = btn.getAttribute("data-act");
      if(act !== "view") return;

      const rid = btn.getAttribute("data-id") || "";
      const row = idCol ? rows.find(r => String(r[idCol]||"").trim() === String(rid).trim()) : null;
      if(!row){ toast("No se encontró el registro."); return; }

      const html = headers.map(h => `
        <div class="fg">
          <label>${escapeHtml(h)}</label>
          <div class="v">${escapeHtml(row[h])}</div>
        </div>
      `).join("");

      openModal("Detalle del contacto", `<div class="form-grid">${html}</div>`);
    });

    // ====== LOAD ======
    async function loadAll(showToast){
      // 1) Validar sesión y obtener empresa_id si falta
      const me = await apiMe();
      whoChip.textContent = `${me.email} • ${String(me.role||"").toUpperCase()}`;

      if(!empresa_id){
        const emp = String(me.empresa_id || "").trim().toLowerCase();
        if(emp){
          empresa_id = emp;
          localStorage.setItem(EMPRESA_KEY, empresa_id);
        }
      }

      if(!empresa_id){
        empresaIdEl.textContent = "—";
        emptyBox.textContent = "Este usuario no tiene empresa asignada (empresa_id) en ADMIN.";
        emptyBox.classList.remove("hidden");
        throw new Error("Panel no configurado (empresa_id faltante).");
      }

      empresaIdEl.textContent = empresa_id;

      // 2) Cargar leads
      const data = await apiListLeads();
      headers = Array.isArray(data.headers) ? data.headers : [];
      rows = Array.isArray(data.rows) ? data.rows : [];

      // 3) Detect columns
      idCol = findHeader(["id","ID","Id"]);
      dateCol = findHeader(["Fecha","fecha","timestamp","Timestamp"]);
      vendedorCol = findHeader(["Vendedor","vendedor"]);
      interesCol = findHeader(["Interés","Interes","interes","intereses","Servicio","servicio"]);

      buildHeader();
      computeKPIs();
      buildFilters();
      applyFilters();

      if(showToast) toast("Actualizado.");
    }

    async function init(){
      if(!ensureSessionOrRedirect()) return;

      try{
        await loadAll(false);
      }catch(err){
        console.error(err);
        const msg = String(err?.message || err);

        // Si token expiró / inválido → vuelve a login
        if(msg.toLowerCase().includes("token")){
          localStorage.removeItem(TOKEN_KEY);
          localStorage.removeItem(EMPRESA_KEY);
          location.href = "login.html";
          return;
        }

        toast(msg);
      }
    }

    init();
  </script>
</body>
</html>
